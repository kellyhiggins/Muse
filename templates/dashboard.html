<!DOCTYPE html>


<!-- <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">  -->

<html>
    <head>
        <title>A Pirate's Radio</title>
        <meta charset=utf-8 />
        <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
        <script src='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'></script>
        <link href='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.css' rel='stylesheet' />
        <script src='https://code.jquery.com/jquery-1.11.0.min.js'></script>
        <link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" >
        <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
        <style>
            body { margin:0; padding:0; }
            #map { height : 500px;}
/*            #directions {position: absolute; width: 25%; max-width: 300px; min-width: 150px;}
            #directions {z-index: 99; background: rgba(0,0,0,.8); top: 0; right: 0; bottom: 0; overflow: auto;}*/
        </style>
    </head>

    <body>
        <div id='title' class='container-fluid'>
            <h1>A Pirate's Radio</h1>
            <h2>Inspired playlists for inspired people</h2>
        </div>

        <div class='container'>
            <div class='row'>
                <div id='place' class='col-sm-3'>
                
                    <label>
                        <p>Where from?<input type="text" id="origin" placeholder="my current location">
                        <a href="#" id="location_playlist_btn" data-toggle="tooltip" title="Make me a playlist based on my current location!">music-button</a>
                        </p>
                    </label>

                    <!-- when the user is done typing, geocoder submission shold happen to show the place on map -->
                    <label><p>Where to?<input type="text" id="destination">
                    </label></p>

                    <a href="#" class="routing-btn" data-toggle="tooltip" data-routing="walking" title="Make me a playlist based on a walk!">walk-button </a>
                    <a href="#" class="routing-btn" data-toggle="tooltip" data-routing="cycling" title="Make me a playlist based on a bikeride!">bike-button </a>
                    <a href="#" class="routing-btn" data-toggle="tooltip" data-routing="driving" title="Make me a playlist based on a drive!">drive-button </a>

                    <!-- when one of these buttons is clicked, the map animates, playlist changes
                    message flashes 'playlist added to your spotify account. enjoy the soundtrack for your journey!' -->
                    
                </div>

                <div id='map' class='col-sm-6'>Hi, I'm a map!</div>

                <div id= 'keyword' class='col-sm-3'>
                    <form action ='/create-keyword-playlist' method="POST">
                        <label>What would you like to hear about? <input type="text" name="search_term">
                        </label>
                        <input type="submit" value="Find me songs with this theme!">
                    </form>

                    <!-- when user gets to page, it will display a default playlist
                    that will change to the playlist that user generates -->

                    {% if playlist_id %}
                        <iframe id='place-playlist' src="https://embed.spotify.com/?uri=spotify:user:{{user_id}}:playlist:{{playlist_id}}" width="300" height="380" frameborder="0" allowtransparency="true"></iframe>
                    {% else %}
                        <iframe id='place-playlist' src="https://embed.spotify.com/?uri=spotify:user:kellyannhiggins:playlist:25OiILy6Gp0Cg4DuuJ7cKy" width="300" height="380" frameborder="0" allowtransparency="true"></iframe>
                    {% endif %}

                </div>
            </div>
        </div>


        </body>

        <script>
        L.mapbox.accessToken = 'pk.eyJ1Ijoia2VsbHlhbm4iLCJhIjoiY2lvYmFqcnNlMDNwbnZ3bHpiZXlsYjVqbiJ9.0-hM3fi1TlEhf7pmXpfsrQ';

        // Hackbright
        var user_lat = 37.788681;
        var user_long = -122.411552;
        var directions = 'hello';

        // Dogpatch Studios
        // var user_lat = 37.7598324;
        // var user_long = -122.391481;

        var user_timestamp = Date.now();

        getLocation();

        var map = L.mapbox.map('map', 'kellyann.dcbde2d4')
            .setView([user_lat, user_long], 13);

        var geocoder = L.mapbox.geocoder('mapbox.places');

        var marker = new L.Marker(new L.LatLng(user_lat, user_long));
        map.addLayer(marker);

        var route = L.mapbox.featureLayer();

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(getCoordinates);
            } else {
                console.log("geolocation not found!");
            }
        }

        function getCoordinates(position) {
            user_lat = position.coords.latitude;
            user_lon = position.coords.longitude;
            user_timestamp = position.timestamp;
        }

        $(document).ready(function() {
            $('[data-toggle="tooltip"]').tooltip();
        });


        // var geocoded_origin = userGeocode(origin)
        // var geocoded_dest = userGeocode(destination)

        function makeLocationPlaylist(evt) {
            var origin = $('#origin').val();
            $.post('/create-location-playlist.json', {'user_long': user_long, 'user_lat': user_lat, 'origin': origin}, returnLocationPlaylist);
        }

        function returnLocationPlaylist(data) {
            var user_id = data.user_id;
            var playlist_id = data.playlist_id;
           var newsrc = "https://embed.spotify.com/?uri=spotify:user:"+ user_id +':playlist:' + playlist_id;
           $("#place-playlist").removeAttr('src');
           $("#place-playlist").attr('src', newsrc);
            // do i want to add a marker on the map, or change the marker?
        }


        // function userGeocode(inputString) {
        //     geocoder.query(inputString);
        // }

        $('#location_playlist_btn').click(makeLocationPlaylist);

        function makeRoutePlaylist(evt) {
            var origin = $('#origin').val();
            var destination = $('#destination').val();
            $.post('/create-journey-playlist.json', {'origin': origin, 'destination': destination, 'routing': $(this).data("routing")}, returnJourneyPlaylist)
        } 


        function returnJourneyPlaylist(data) {
               var user_id = data.user_id;
               var playlist_id = data.playlist_id;
               directions = data.directions;
               console.log(playlist_id);
               console.log('these are directions', JSON.stringify(directions.routes[0].geometry, null, 2));
               route.clearLayers();
               route = L.mapbox.featureLayer(directions.routes[0].geometry).addTo(map);
               map.fitBounds(route);
               var newsrc = "https://embed.spotify.com/?uri=spotify:user:"+ user_id +':playlist:' + playlist_id;
               $("#place-playlist").removeAttr('src');
               $("#place-playlist").attr('src', newsrc);
        }
        function waitingForPlaylist () {$('.routing-btn').click(makeRoutePlaylist);
    };

        $(document).ready(waitingForPlaylist);


         </script>


<!--         // geocoder.query('current_location_input', showMap);

        // // Geocoder can return an area or a point (like a city or address).
        // // To handle both cases, the map bounds to an area or zooms to a point
        // function showMap(err, data) {
        //     if (data.lbounds) {
        //         map.fitBounds(data.lbounds);
        //     } else if (data.latlng) {
        //         map.setView([data.latlng[0], data.latlng[1]], 13);
        //     }
        // }


        // Adding a custom Marker
            // var marker = L.icon({
            //     iconUrl: 'https://bit.ly/QIMos7',
            //     iconAnchor: [20, 50]
            // });


        // Adding GeoJSON
            // L.mapbox.featureLayer()
            //     .loadURL('/help/data/examples/data.geojson')
            //     .addTo(map);


        // Adding Geocoder
        // var geocoder = L.mapbox.geocoder('mapbox.places-v1');
        // geocoder.query('New York City', showMap);

        // function showMap(err, data) {
        //     if (data.lbounds) {
        //         map.fitBounds(data.lbounds);
        //         var marker = L.marker([data.latlng[0], data.latlng[1]]).addTo(map);
        //     } else if (data.latlng) {
        //         map.setView([data.latlng[0], data.latlng[1]], 13);
        //     }
        // }


        // Event Handling
        // map.on('dblclick', function(e) {
        //     alert(e.latlng);
        // });


        // $(document).ready(getLocation);
        // function updateMarkerLocation(lat, long){
        //     marker.
            // change marker variable in 
            // Meggies' Advice create a hidden span that has the user_lat long,
// select as needed
// use dom as notebook that 
// wrap marker in updateMarkerLocation
        // } -->

       
</html>
